# Multilingual RAG Backend - API Documentation & System Design

## 🧩 Overview

This backend is a **FastAPI-based** system supporting multilingual **Retrieval-Augmented Generation (RAG)** for question answering over user-uploaded documents. It supports:

- User registration & authentication
- PDF document upload
- Embedding and vector storage
- Contextual querying with Gemini LLM
- Chat history retrieval

---

## 📘 API Documentation

### Root Endpoint

```http
GET /
```

Returns:

```json
{ "msg": "Multilingual RAG backend running" }
```

---

### 🔐 Auth APIs

#### POST `/auth/signup`

Create a new user and send their autogenerated username to email.

**Flow:**

- User provides **email** and **password**.
- System checks if email already exists.
- If not, a unique **username** is generated.
- The username is sent to the provided email.
- User is informed to check email for username.

Request Body:

```json
{
  "email": "user@example.com",
  "password": "secure-password"
}
```

Response:

```json
{
  "msg": "User created. Username has been sent to your email."
}
```

#### POST `/auth/token`

Login using **username** and **password** (not email).

**Flow:**

- User enters **username** and **password**.
- If credentials are correct, system issues a JWT token.
- If incorrect, it returns an error.

Form Data:

```
username=...&password=...
```

Response:

```json
{
  "access_token": "jwt-token",
  "token_type": "bearer"
}
```

If login fails:

```json
{
  "detail": "Incorrect username or password"
}
```

#### GET `/auth/user`

Get the logged-in user's profile.

Authorization: `Bearer <token>`

Response:

```json
{
  "username": "user-1a2b3c4d",
  "email": "user@example.com"
}
```

---

### 📤 Upload APIs

#### POST `/upload/`

Upload a PDF file for embedding and vector storage.

Headers:

- Authorization: Bearer token

Form Data:

- `file`: PDF

Response:

```json
{ "msg": "File uploaded and processed" }
```

---

### 💬 Chat APIs

#### POST `/chat/`

Query documents and get a Gemini-generated answer.

Request Body:

```json
{ "query": "What is quantum computing?" }
```

Headers:

- Authorization: Bearer token

Response:

```json
{ "answer": "Quantum computing is... thanks for asking!" }
```

#### GET `/chat/history`

Get previous chat logs for the authenticated user.

Response:

```json
[
  { "query": "What is AI?", "answer": "AI is..." },
  ...
]
```

---

## 🧠 How RAG Works

**Retrieval-Augmented Generation Flow:**

1. **Document Upload**:

   - PDF is uploaded via `/upload/`
   - Content is split into pages
   - Full content is embedded using Gemini Embedding API
   - Embedding + content is stored in MongoDB

2. **User Query**:

   - User submits a query via `/chat/`
   - Query is embedded
   - Similarity search is done against stored document embeddings (cosine similarity)
   - Top-k matching contents are retrieved
   - These are passed as context to Gemini LLM
   - Gemini generates an answer based on context + question

### 🔁 Diagram - RAG Flow

```text
[User] ─┬─> /upload ───> [Extract Text + Embed] ───> [MongoDB: Store Embeddings]
        │
        └─> /chat ───> [Embed Query] ─> [Vector Search] ─> [Top-K Context]
                                     └─> [Gemini LLM] ──> [Response]
```

---

## 🏛️ System Design (High Level)

### 📦 Architecture Components

```
[ FastAPI App ]
  ├── Auth API          ─ user creation, login, JWT
  ├── Upload API        ─ document upload
  ├── Chat API          ─ contextual Q&A via Gemini
  ├── MongoDB           ─ users, chats, documents (with embeddings)
  ├── Emailer           ─ email generated username
  ├── Gemini Embedding  ─ document/query embedding
  ├── Gemini LLM        ─ answer generation
```

### 🌐 External Dependencies

- Google Gemini Embedding + Chat API
- MongoDB (cloud or local)
- SMTP for sending welcome emails

---

## ⚙️ System Design (Low Level)

### Components:

- `main.py`: Mounts routers, configures CORS
- `auth.py`: Handles signup, login, user fetch
- `chat.py`: RAG pipeline and chat history
- `upload.py`: Stores embedded PDFs
- `vector.py`: Embeds + stores document vectors
- `gemini.py`: Defines prompt + calls Gemini
- `embedder.py`: Embeds text via Gemini
- `mongo.py`: Vector search and persistence

### MongoDB Collections:

- `users`: { username, email, hashed\_password }
- `chats`: { username, query, answer }
- `documents`: { username, content, embedding }

---

## Diagram 

### System Architecture

<img width="3617" height="3846" alt="Untitled diagram _ Mermaid Chart-2025-07-24-060116" src="https://github.com/user-attachments/assets/e2ab6f69-71f2-47f3-9f58-fcd8fdfd7083" />

### Component Interaction

<img width="1186" height="373" alt="Component Interface" src="https://github.com/user-attachments/assets/5ffda8a5-2d16-4b85-a4c3-d4b5867a17fa" />

---

## 🔒 Auth Flow

- User signs up with **email** and **password**.
- Backend generates a unique **username** (e.g., `user-1a2b3c4d`).
- Sends the username to the user via email.
- User then logs in using **username** + **password** (not email).
- Passwords hashed via `bcrypt`
- Token generated via JWT (HS256)
- Token passed via `Authorization: Bearer <token>`
- Login fails with HTTP 400 if credentials are invalid.

---

## 🛠️ Technologies Used

- **FastAPI** – API framework
- **MongoDB** – vector + user storage
- **Gemini LLM** – embeddings & responses
- **Langchain** – wrapper around Gemini
- **scikit-learn** – cosine similarity

---

## 🧪 Testing & Docs

Once deployed, docs are available at:

```
GET /docs  # Swagger UI
GET /redoc # ReDoc
```

---

## 📦 Deployment

- Dockerized via `Dockerfile`
- Run with:

```bash
docker build -t rag-backend .
docker run -p 8000:8000 rag-backend
```
